# /etc/nginx/conf.d/airflow.conf
upstream airflow_web {
    server 127.0.0.1:8080;
    keepalive 64;
}

# If you are terminating TLS elsewhere (like Cloudflare),
# you can keep only port 80 and remove the 443 blocks.

server {
    listen 80;
    server_name 52.202.130.113;

    # Optional: force HTTPS if you later enable SSL below
    # return 301 https://$host$request_uri;

    client_max_body_size 50m;

    # Good defaults for reverse proxy
    proxy_http_version 1.1;
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # WebSocket support (Airflow UI can use it in some setups; safe to include)
    proxy_set_header Upgrade           $http_upgrade;
    proxy_set_header Connection        "upgrade";

    # Timeouts (tasks/logs pages can be slow)
    proxy_connect_timeout 60s;
    proxy_send_timeout    300s;
    proxy_read_timeout    300s;

    # Main proxy
    location / {
        proxy_pass http://airflow_web;
        proxy_buffering off;
        proxy_redirect off;
    }

    # Optional: deny access to internal endpoints if you want to be strict
    # location ~* ^/(api/v1|api/v2) {
    #     allow 1.2.3.4;  # your office IP
    #     deny all;
    #     proxy_pass http://airflow_web;
    # }
}